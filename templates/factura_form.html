{% extends "base.html" %}

{% block title %}Nueva Factura{% endblock %}
{% block page_title %}Emitir Nueva Factura{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{{ url_for('facturas') }}">Facturas</a></li>
<li class="breadcrumb-item active">Nueva</li>
{% endblock %}

{% block content %}
<form method="POST" id="formFactura">
    <div class="row">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Datos del Cliente</h3>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label for="id_cliente">Cliente *</label>
                        <select class="form-control" id="id_cliente" name="id_cliente" required>
                            <option value="">Seleccione un cliente...</option>
                            {% for cliente in clientes %}
                            <option value="{{ cliente.id_cliente }}">{{ cliente.nombre }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Agregar Productos</h3>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label for="producto_sel">Producto</label>
                        <select class="form-control" id="producto_sel">
                            <option value="">Seleccione un producto...</option>
                            {% for producto in productos %}
                            <option value="{{ producto.id_producto }}" 
                                    data-precio="{{ producto.precio }}"
                                    data-stock="{{ producto.stock }}"
                                    data-descripcion="{{ producto.descripcion }}">
                                {{ producto.descripcion }} - ${{ "%.2f"|format(producto.precio) }} (Stock: {{ producto.stock }})
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="cantidad">Cantidad</label>
                        <input type="number" class="form-control" id="cantidad" min="1" value="1">
                    </div>
                    <button type="button" class="btn btn-primary" id="btnAgregar">
                        <i class="fas fa-plus"></i> Agregar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Detalle de la Factura</h3>
        </div>
        <div class="card-body">
            <table class="table table-bordered" id="tablaDetalle">
                <thead>
                    <tr>
                        <th>Producto</th>
                        <th>Cantidad</th>
                        <th>Precio Unit.</th>
                        <th>Subtotal</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="detalleBody">
                    <tr id="emptyRow">
                        <td colspan="5" class="text-center">No hay productos agregados</td>
                    </tr>
                </tbody>
                <tfoot>
                    <tr>
                        <th colspan="3" class="text-right">TOTAL:</th>
                        <th id="totalFactura">$0.00</th>
                        <th></th>
                    </tr>
                </tfoot>
            </table>
            <input type="hidden" name="productos" id="productosJson">
        </div>
        <div class="card-footer">
            <button type="submit" class="btn btn-success" id="btnGuardar">
                <i class="fas fa-save"></i> Emitir Factura
            </button>
            <a href="{{ url_for('facturas') }}" class="btn btn-secondary">
                <i class="fas fa-times"></i> Cancelar
            </a>
        </div>
    </div>
</form>
{% endblock %}

{% block extra_js %}
<script>

let productos = [];

document.getElementById('btnAgregar').addEventListener('click', function() {
    const select = document.getElementById('producto_sel');
    const cantidad = parseInt(document.getElementById('cantidad').value);
    
    if (!select.value || cantidad <= 0) {
        alert('Seleccione un producto y cantidad vÃ¡lida');
        return;
    }
    
    const option = select.options[select.selectedIndex];
    const stock = parseInt(option.dataset.stock);
    
    if (cantidad > stock) {
        alert('Cantidad excede el stock disponible');
        return;
    }
    
    const producto = {
        id_producto: select.value,
        descripcion: option.dataset.descripcion,
        cantidad: cantidad,
        precio: parseFloat(option.dataset.precio),
        subtotal: cantidad * parseFloat(option.dataset.precio)
    };
    
    productos.push(producto);
    actualizarTabla();
    select.value = '';
    document.getElementById('cantidad').value = '1';
});

function actualizarTabla() {
    const tbody = document.getElementById('detalleBody');
    tbody.innerHTML = '';
    
    if (productos.length === 0) {
        tbody.innerHTML = '<tr id="emptyRow"><td colspan="5" class="text-center">No hay productos agregados</td></tr>';
        document.getElementById('totalFactura').textContent = '$0.00';
        return;
    }
    
    let total = 0;
    productos.forEach((p, index) => {
        const row = tbody.insertRow();
        row.innerHTML = `
            <td>${p.descripcion}</td>
            <td>${p.cantidad}</td>
            <td>$${p.precio.toFixed(2)}</td>
            <td>$${p.subtotal.toFixed(2)}</td>
            <td>
                <button type="button" class="btn btn-danger btn-sm" onclick="eliminarProducto(${index})">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;
        total += p.subtotal;
    });
    
    document.getElementById('totalFactura').textContent = '$' + total.toFixed(2);
    document.getElementById('productosJson').value = JSON.stringify(productos);
}

function eliminarProducto(index) {
    productos.splice(index, 1);
    actualizarTabla();
}

document.getElementById('formFactura').addEventListener('submit', function(e) {
    if (productos.length === 0) {
        e.preventDefault();
        alert('Debe agregar al menos un producto');
    }
});
</script>
{% endblock %}